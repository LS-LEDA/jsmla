class BrowserStorage{constructor(t){}load(t){this._widgets=JSON.parse(localStorage.getItem(t.name))}save(t){let e=document.createElement("a");document.body.appendChild(e),e.style="display: none";let i=JSON.stringify(t.data),s=new Blob([i],{type:"octet/stream"}),n=window.URL.createObjectURL(s);e.href=n,e.download=t.fileName,e.click(),window.URL.revokeObjectURL(n),e.remove()}saveIndex(){}}class Dashboard{constructor(t){this._version="",this._gobalCfg=t.global,this._bstorage=new BrowserStorage,this._widgets=new Array,this._counter=0,this._widgetDefaults=t.widget,this._msldb=new MoodleStandardLogsDataBase(t.db),this._modal=new ModalPopup}get gobalCfg(){return this._gobalCfg}get widgets(){return this._widgets}get widgetTemplate(){return this._widgetTemplate}get msldb(){return this._msldb}get modal(){return this._modal}get bstorage(){return this._bstorage}getWidgetById(t){return this._widgets.find(e=>t==e.id)}setWidgetById(t,e){let i=this._widgets.find(e=>t==e.id);this._widgets[i._index]=e}createWidget(t){if(void 0!==this._widgetDefaults)for(let e in this._widgetDefaults)void 0===t[e]&&(t[e]=this._widgetDefaults[e]);let e=new Widget(++this._counter,t);this._widgets.push(e)}download(t){dashb.bstorage.save({fileName:t+".dsb",data:this.toObject()})}import(t){}init(){this._modal.init(),document.head.insertAdjacentHTML("beforeend",'<style type="text/css">'+this._gobalCfg.css+"</style>")}readFromFile(e,callbackLoad){var file=e.target.files[0],reader=new FileReader;if(!file)throw new Error({errno:ERROR_EXCEPTION_FILE,msg:"Invalid file."});let self=this;reader.onload=function(e){let dashbObj=JSON.parse(e.target.result);self._gobalCfg=dashbObj.global,self._widgetDefaults=dashbObj.widget,self._msldb._schema=eval(dashbObj.db.schema.replace(/function .*()/g,"item=>")),self._msldb._filters=eval(dashbObj.db.filters.replace(/function .*()/g,"()=>")),self._msldb._globalFilter=eval(dashbObj.db.globalFilter),self._msldb._widgetFilter=eval(dashbObj.db.widgetFilter),self._counter=0,e.widgets=dashbObj.widgets,callbackLoad(e)},reader.readAsText(file)}renderAllWidgets(t,e){this._widgets.forEach(i=>{this.renderWidget(i,t,e)})}renderWidget(t,e,i){t.resetLabelsAndValues(),t.resetEvals(),t.evalCSSHTML(),WIDGET_CODE_SNIPPET===t.mode?(Array.isArray(t.filter)?t.filter.forEach(e=>{this._msldb.filter(e);let i=this._msldb.labelsAndValues(t.field,t.sortBy,t.order,t.limit,t.calcFn);t.data.labels[t.data.labels.length]=i.labels,t.data.values[t.data.values.length]=i.values}):(this._msldb.filter(t.filter),t.data=this._msldb.labelsAndValues(t.field,t.sortBy,t.order,t.limit,t.calcFn)),e(t)):i(t)}toObject(){let t={version:"0",global:this._gobalCfg,widget:this._widgetDefaults,db:{schema:this._msldb._schema.toString(),filters:this._msldb._filters.toString(),globalFilter:this._msldb._globalFilter,widgetFilter:this._msldb.widgetFilter},widgets:[]};for(let e=0;e<this._widgets.length;e++)t.widgets[t.widgets.length]=this._widgets[e].export();return t}}const ERROR_EXCEPTION_BREAK=0,ERROR_EXCEPTION_FILE=1;class Error{constructor(t){this._errno=t.errno,this._msg=t.msg}get msg(){return this._msg}get errno(){return this._errno}get error(){return{errno:this._errno,msg:this._msg}}set msg(t){this._msg=t}set errno(t){this._errno=t}set error(t){this._errno=t.errno,this._msg=t.msg}}class FileHandler{constructor(t){this._callback=t.callback,this._dropArea=t.dropArea,this._fileInput=t.fileInput,this._classHighlight=t.classHighlight}setHandlers(){function t(t){[...t].forEach(e)}function e(t){l._callback({target:{files:[t]}})}function i(e){t(e.dataTransfer.files)}function s(t){t.preventDefault(),t.stopPropagation()}function n(t){r.classList.add(l._classHighlight)}function o(t){r.classList.remove(l._classHighlight)}var r=this._dropArea,l=this;void 0!==r&&(["dragenter","dragover","dragleave","drop"].forEach(t=>{r.addEventListener(t,s,!1)}),["dragenter","dragover"].forEach(t=>{r.addEventListener(t,n,!1)}),["dragleave","drop"].forEach(t=>{r.addEventListener(t,o,!1)}),r.addEventListener("drop",i,!1)),this._fileInput.addEventListener("change",this._callback,!1)}}class I18N{constructor(t){this._lang=i18Config.lang,this._keys=i18Config.keys}str(t){}}var eventModalPopup;class ModalPopup{constructor(t){eventModalPopup=this,void 0!==t&&void 0!==t.template?this._template=t.template:this._template='<style type="text/css">        #modal {display: none;position: fixed;z-index: 1;left: 0;top: 0;width: 100%;height: 100%;overflow: auto;background-color: rgb(0,0,0);background-color: rgba(0,0,0,0.4);}        #modal .container {background-color: #fefefe;margin: 70px auto;border: 3px solid #666666;width: 80%;overflow: auto;resize: both;}        #modal .content {padding: 10px 16px;}        #modal .header {padding: 2px 16px;background-color: #333;line-height: 20px;}        #modal .header .content {color: white;font-size: 22px;font-weight: bold;padding-left:0px !important;}        #modal .close {color: #aaa;float: right;font-size: 40px;font-weight: bold;cursor: pointer;margin-top:10px;}        #modal .close:hover,.close:focus {color: white;text-decoration: none;cursor: pointer;}        </style>        <div id="modal">            <div class="container">                <div class="header">                  <span class="close">&times;</span>                  <div id="header" class="content"></div>                </div>              <div id="body" class="content"></div>            </div>        </div>'}init(t){let e;e=void 0!==t&&void 0!==t.classes?t.classes:{modalId:"modal",containerClass:".container",headerClass:".header",headerContentClass:".header > .content",contentClass:".container > .content",closeClass:".close"};let i=document.getElementById(e.modalId);[null,void 0].includes(i),document.body.insertAdjacentHTML("beforeend",this._template),this._window=document.getElementById(e.modalId),this._container=this._window.querySelector(e.containerClass),this._header=this._window.querySelector(e.headerClass),this._headerContent=this._header.querySelector(e.headerContentClass),this._content=this._container.querySelector(e.contentClass),this._closeBtn=this._container.querySelector(e.closeClass),["click"].forEach(t=>{this._closeBtn.addEventListener(t,this.close)})}set headerContent(t){this._headerContent.innerHTML="",this._headerContent.insertAdjacentHTML("afterbegin",t)}set content(t){this._content.innerHTML="",this._content.insertAdjacentHTML("afterbegin",t)}show(){this._window.style.display="block",["click"].forEach(t=>{window.addEventListener(t,this.closeEvent,!1)})}close(){eventModalPopup._window.style.display="none",["click"].forEach(t=>{window.removeEventListener(t,eventModalPopup.clickEvent)})}closeEvent(t){t.target==eventModalPopup._window&&eventModalPopup.close()}}class MoodleStandardLogsDataBase{constructor(t){this._logs=new Array,this._rawLogs=new Array,this._schema=t.schema,this._filters=t.filters,this._globalFilter=void 0!==t.globalFilter?t.globalFilter:{},this._widgetFilter=void 0!==t.widgetFilter?t.widgetFilter:{},this._navigator={}}get logs(){return this._logs}get globalFilter(){return this._globalFilter}get widgetFilter(){return this._widgetFilter}set globalFilter(t){this._globalFilter=t}set widgetFilter(t){this._widgetFilter=t}schema(t){return{fullDate:t[0],yearMonthDay:t[0].substr(6,4)+""+t[0].substr(3,2)+t[0].substr(0,2),yearMonthDayHourMinute:t[0].substr(6,4)+""+t[0].substr(3,2)+t[0].substr(0,2)+t[0].substr(11,2)+t[0].substr(14,2),timestamp:Date.parse(t[0])/1e3,user:t[1],affectedUser:t[2],context:t[3],component:t[4],event:t[5],description:t[6],origin:t[7],ip:t[8]}}readLogFromFile(t,e,i){var s=t.target.files[0],n=new FileReader,o=this._logs;if(!s)throw new Error({errno:ERROR_EXCEPTION_FILE,msg:"Invalid file."});let r=this;n.onload=function(t){JSON.parse(t.target.result)[0].forEach(t=>{o[o.length]=t}),r.init(),t.fileName=s.name,e(t)},n.onprogress=function(t){void 0!==i&&i(t)},n.readAsText(s)}filter(t){this.logsCopy(this._logs,this._rawLogs);for(let e in t)void 0!==this._widgetFilter[e]&&delete t[e];this.applyFilter(t),this.applyFilter(this._widgetFilter)}applyFilter(t){if(this._logs=this._logs.map(t=>{let e=t;return Array.isArray(t)&&(e={},e=void 0===this._schema?this.schema(t):this._schema(t)),e}),void 0!==t)for(let e in t)Array.isArray(t[e])&&t[e].forEach(t=>{let i=new Array;this._logs.forEach(s=>{this.filterRegEx(s,e,t)&&i.push(s)}),this._logs=i})}filterRegEx(t,e,i){let s=!1,n=-1<i.indexOf("NOT ");n&&(i=i.replace("NOT ",""));let o,r=this._filters(),l=i.split(" ")[0],a=r[l].regex,d=r[l].fn;if(null!==(o=a.exec(i))){let i=o[1].split(",");s=d(t[e],i[0],i[1]),n&&(s=!s)}return s}init(){this.applyFilter(this._globalFilter),this.logsCopy(this._rawLogs,this._logs)}logsCopy(t,e){t.splice(0,t.length),e.forEach(e=>{t.push(e)})}labelsCount(t,e="value",i="DESC",s){let n={},o=new Array;this._logs.forEach(function(e){n[e[t]]=(n[e[t]]||0)+1});for(var r in n)o.push({key:r,value:n[r]});return n=this.sort(o,e,i),void 0!==s&&(n.length=s),n}labelsCountGroup(t,e="fullDate",i="value",s="DESC",n){let o={},r=new Array,l={};this._logs.forEach(t=>{l[t[e]]=0}),this._logs.forEach(i=>{for(let s in l)if(o[i[t]]=o[i[t]]||{},s===i[e]){o[i[t]][s]=(o[i[t]][s]||0)+1;break}});for(var a in o)r.push({key:a,value:o[a]});return o=this.sort(r,i,s),void 0!==n&&(o.length=n),o}labelsLastInteraction(t,e="fullDate",i="value",s="DESC",n){let o={},r=new Array;this._logs.forEach(function(i){(o[i[t]]<i[e]||void 0===o[i[t]])&&(o[i[t]]=i[e])});for(var l in o)r.push({key:l,value:o[l]});return o=this.sort(r,i,s)}extractByKey(t,e){let i=new Array;for(var s in t)i.push(t[s][e]);return i}labelsAndValues(t,e="value",i="DESC",s,n={fn:"count",field:void 0}){let o={};if(void 0!==t){let r;switch(n.fn){case"count":r=this.labelsCount(t,e,i,s);break;case"countgroup":r=this.labelsCountGroup(t,n.field,e,i,s);break;case"lastconnection":r=this.labelsLastInteraction(t,n.field,e,i,s)}o.labels=this.extractByKey(r,"key"),o.values=this.extractByKey(r,"value")}else o.labels=[""],o.values=[this._logs.length];return o}sort(t,e,i){return e&&(t=t.sort((t,s)=>{return t[e]<s[e]?"DESC"===i?1:-1:t[e]>s[e]?"DESC"===i?-1:1:0})),t}}const WIDGET_CODE_SNIPPET=0,WIDGET_TEXT=1,WIDGET_JS_CSS_LOADING=0,WIDGET_JS_LOADED=1,WIDGET_CSS_LOADED=2;class Widget{constructor(t,e){let i={mode:1,prefix:"widget_",delimiter:"%",width:250,height:250,size:1,visible:!0,field:void 0,sortBy:"value",order:"DESC",limit:void 0,calcFn:{fn:"count",field:void 0},filter:void 0,callback:"editWidget",srcJS:void 0,srcCSS:void 0,snippet:void 0,css:void 0,html:'                <div class="widget" id="%ID%" style="width:%WIDTH%px;height:%HEIGHT%px">                    <h2 id="title_%ID%" class="title" onclick="%CALLBACK%(\'%ID%\');">%TITLE%</h2>                    <div id="content_%ID%" class="content" style="width:%WIDTH%px;height:%HEIGHT%px">%TEXT_CONTENT%</div>                </div>            '};if(void 0!==e)for(let t in e)i[t]=e[t];for(let t in i)this["_"+t]=i[t];this._id=this._prefix+""+t,this._index=t,this.resetLabelsAndValues(),this.resetEvals(),this._loaded=0,this.loadJS(),this.loadCSS()}get calcFn(){return this._calcFn}get data(){return this._data}get evaluatedHTML(){return this._evaluatedHTML}get evaluatedCSS(){return this._evaluatedCSS}get evaluatedCSSHTML(){return this._evaluatedCSS+this._evaluatedHTML}get evaluatedSnippet(){return this._evaluatedSnippet}get executedSnippetResult(){return this._executedSnippetResult}get field(){return this._field}get filter(){return this._filter}get id(){return this._id}get limit(){return this._limit}get loaded(){return this._loaded}get mode(){return this._mode}get order(){return this._order}get sortBy(){return this._sortBy}get visible(){return this._visible}set data(t){this._data=t}evalAndExecuteSnippet(){return this.evalSnippet(),this.executeSnippet()}evalHTML(){return this._evaluatedHTML=this._html.replace(new RegExp(this._delimiter+"ID"+this._delimiter,"g"),this._id).replace(new RegExp(this._delimiter+"CALLBACK"+this._delimiter,"g"),this._callback).replace(new RegExp(this._delimiter+"TITLE"+this._delimiter,"g"),this._title).replace(new RegExp(this._delimiter+"WIDTH"+this._delimiter,"g"),this._width*this._size).replace(new RegExp(this._delimiter+"HEIGHT"+this._delimiter,"g"),this._height*this._size).replace(new RegExp(this._delimiter+"TEXT_CONTENT"+this._delimiter,"g"),""),this._evaluatedHTML}evalCSS(){this._evaluatedCSS=void 0!==this._css?'<style type="text/css">'+this._css+"</style>":""}evalCSSHTML(){this.evalCSS(),this.evalHTML()}evalSnippet(){return this._evaluatedSnippet="",void 0!==this._snippet&&(this._evaluatedSnippet=this._snippet.replace(new RegExp(this._delimiter+"ID"+this._delimiter,"g"),this._id).replace(new RegExp(this._delimiter+"WIDTH"+this._delimiter,"g"),this._width*this._size).replace(new RegExp(this._delimiter+"HEIGHT"+this._delimiter,"g"),this._height*this._size).replace(new RegExp(this._delimiter+"LABELS"+this._delimiter,"g"),JSON.stringify(this._data.labels)).replace(new RegExp(this._delimiter+"VALUES"+this._delimiter,"g"),JSON.stringify(this._data.values)).replace(new RegExp(this._delimiter+"COUNT"+this._delimiter,"g"),0<this._data.values.length?this._data.values.reduce(function(t,e){return t+e}):this._data.values)),this._evaluatedSnippet}executeSnippet(){return this._executedSnippetResult=eval(this._evaluatedSnippet)}export(){let t={};for(let e in this)["_data","_evaluatedCSS","_evaluatedHTML","_evaluatedSnippet","_executedSnippetResult"].includes(e)||(t[e.replace("_","")]=this[e]);return t}loadCSS(){if(["",void 0].includes(this._srcCSS))this._loaded=2|this._loaded;else{Array.from(document.links).forEach(t=>{t.href===this._srcCSS&&(this._loaded=2|this._loaded)});var t=document.createElement("link");t.type="text/css",t.rel="stylesheet",t.href=this._srcCSS;let e=this;t.onload=function(){e._loaded=2|e._loaded},document.head.appendChild(t)}}loadJS(){if(["",void 0].includes(this._srcJS))this._loaded=1|this._loaded;else{Array.from(document.scripts).forEach(t=>{t.src===this._srcJS&&(this._loaded=1|this._loaded)});let t=document.createElement("script");t.type="text/javascript",t.src=this._srcJS;let e=this;t.onload=function(){e._loaded=1|e._loaded},document.head.appendChild(t)}}resetEvals(){this._evaluatedCSS=void 0,this._evaluatedHTML=void 0,this._evaluatedSnippet=void 0,this._executedSnippetResult=void 0}resetLabelsAndValues(){this._data={labels:[],values:[]}}}